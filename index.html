<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Titled Code Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --border: #1f2937;
      --btn: #0ea5e9;
      --btn-2: #14b8a6;
      --btn-3: #a78bfa;
      --radius: 12px;
    }

    html, body {
      height: 100%;
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1020 40%, var(--bg) 100%);
      color: var(--text);
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    .wrap {
      max-width: 1100px;
      margin: 40px auto 80px;
      padding: 0 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.2px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      background: var(--btn);
      transition: transform .05s ease, filter .15s ease;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    .btn-green { background: var(--btn-2); }
    .btn-purple { background: var(--btn-3); }

    /* 1 block per row */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .block {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display: flex;
      flex-direction: column;
      min-height: 400px; /* bigger block height */
    }

    .block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
    }

    .title {
      font-size: 15px;
      font-weight: 700;
      outline: none;
      border: none;
      background: transparent;
      color: var(--text);
      padding: 6px 8px;
      border-radius: 8px;
    }

    .code-wrap {
      position: relative;
      padding: 12px;
      flex: 1;
    }

    pre {
      margin: 0;
      overflow: auto;
      height: 100%;
      min-height: 350px; /* larger editable area */
      border-radius: 10px;
      border: 1px solid var(--border);
      background: radial-gradient(1200px 400px at 80% -80%, rgba(80,200,255,0.15), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      padding: 14px;
      font-size: 14px;
      line-height: 1.5;
      color: #e6edf3;
    }

    code[contenteditable="true"] {
      display: block;
      white-space: pre;
      caret-color: #fff;
      outline: none;
    }

    footer {
      text-align: center;
      margin-top: 26px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸŽ¯ TPM TSS Demo</h1>
      <div class="toolbar">
        <button class="btn-green">Add New Block</button>
        <button class="btn-purple">Download All</button>
      </div>
    </header>

    <section class="grid">
      <article class="block">
        <div class="block-header">
          <div class="title" contenteditable="true">C++ Snippet</div>
          <div>
            <button>Copy</button>
            <button class="btn-green">Download</button>
          </div>
        </div>
        <div class="code-wrap">
          <pre><code contenteditable="true">
<!-- Your CODE goes here -->
Indigo::bool_t TPMManager_User::nv_undefine(
    Indigo::uint32_t nv_index,
    const Indigo::Vector<Indigo::uint8_t>& owner_auth,
    const Indigo::Vector<Indigo::uint8_t>& platform_auth)
{
    // 0) ESAPI init
    TSS2_ABI_VERSION abi = TSS2_ABI_VERSION_CURRENT;
    ESYS_CONTEXT* esys = nullptr;
    TSS2_RC rc = Esys_Initialize(&esys, p_tcti_context, &abi);
    if (rc != TSS2_RC_SUCCESS) {
        LOG(ERROR) << "nv_undefine: Esys_Initialize rc=0x" << std::hex << rc;
        return false;
    }

    // 1) If it doesn't exist, we're "done" (idempotent success)
    ESYS_TR nvHandle = ESYS_TR_NONE;
    rc = Esys_TR_FromTPMPublic(esys, nv_index, ESYS_TR_NONE, ESYS_TR_NONE, ESYS_TR_NONE, &nvHandle);
    if (rc != TSS2_RC_SUCCESS) {
        LOG(INFO) << "nv_undefine: index 0x" << std::hex << nv_index << " not defined";
        Esys_Finalize(&esys);
        return true;
    }

    // 2) Read public area to determine attributes / creator
    TPM2B_NV_PUBLIC* pub = nullptr;
    TPM2B_NAME* name = nullptr;
    rc = Esys_NV_ReadPublic(esys, nvHandle, ESYS_TR_NONE, ESYS_TR_NONE, ESYS_TR_NONE, &pub, &name);
    if (rc != TSS2_RC_SUCCESS || !pub) {
        LOG(ERROR) << "nv_undefine: NV_ReadPublic rc=0x" << std::hex << rc;
        if (name) Esys_Free(name);
        Esys_TR_Close(esys, &nvHandle);
        Esys_Finalize(&esys);
        return false;
    }

    TPMA_NV attrs = pub->nvPublic.attributes;
    const bool platform_created = (attrs & TPMA_NV_PLATFORMCREATE) != 0;
    const bool policy_delete    = (attrs & TPMA_NV_POLICY_DELETE) != 0;

    // NOTE: This helper does not implement POLICY_DELETE flows. Most standard indexes
    // (including ones you defined with AUTHREAD/AUTHWRITE or POLICYREAD/POLICYWRITE)
    // do NOT set POLICY_DELETE; for those, NV_UndefineSpace is sufficient.
    if (policy_delete) {
        LOG(ERROR) << "nv_undefine: index has TPMA_NV_POLICY_DELETE; "
                   << "NV_UndefineSpaceSpecial + policy session required (not implemented here).";
        Esys_Free(pub); if (name) Esys_Free(name);
        Esys_TR_Close(esys, &nvHandle);
        Esys_Finalize(&esys);
        return false;
    }

    // 3) Choose hierarchy (Owner for owner-created; Platform for platform-created)
    ESYS_TR authHandle = platform_created ? ESYS_TR_RH_PLATFORM : ESYS_TR_RH_OWNER;

    // Set hierarchy auth (empty by default unless you configured one)
    TPM2B_AUTH authBuf{};
    if (platform_created) {
        authBuf.size = std::min<size_t>(platform_auth.size(), sizeof authBuf.buffer);
        if (authBuf.size) memcpy(authBuf.buffer, platform_auth.data(), authBuf.size);
        Esys_TR_SetAuth(esys, authHandle, &authBuf);
    } else {
        authBuf.size = std::min<size_t>(owner_auth.size(), sizeof authBuf.buffer);
        if (authBuf.size) memcpy(authBuf.buffer, owner_auth.data(), authBuf.size);
        Esys_TR_SetAuth(esys, authHandle, &authBuf);
    }

    // 4) Attempt undefine under the chosen hierarchy
    rc = Esys_NV_UndefineSpace(esys,
                               authHandle, nvHandle,
                               /*sh1*/ESYS_TR_PASSWORD, /*sh2*/ESYS_TR_NONE, /*sh3*/ESYS_TR_NONE);

    if (rc != TSS2_RC_SUCCESS) {
        // Fallback: try the other hierarchy in case the PLATFORMCREATE bit is misleading
        LOG(WARNING) << "nv_undefine: NV_UndefineSpace rc=0x" << std::hex << rc
                     << " with " << (platform_created ? "PLATFORM" : "OWNER")
                     << " â€” retrying with the other hierarchy";

        ESYS_TR altAuth = platform_created ? ESYS_TR_RH_OWNER : ESYS_TR_RH_PLATFORM;
        TPM2B_AUTH altBuf{};
        if (altAuth == ESYS_TR_RH_OWNER) {
            altBuf.size = std::min<size_t>(owner_auth.size(), sizeof altBuf.buffer);
            if (altBuf.size) memcpy(altBuf.buffer, owner_auth.data(), altBuf.size);
        } else {
            altBuf.size = std::min<size_t>(platform_auth.size(), sizeof altBuf.buffer);
            if (altBuf.size) memcpy(altBuf.buffer, platform_auth.data(), altBuf.size);
        }
        Esys_TR_SetAuth(esys, altAuth, &altBuf);

        rc = Esys_NV_UndefineSpace(esys, altAuth, nvHandle,
                                   ESYS_TR_PASSWORD, ESYS_TR_NONE, ESYS_TR_NONE);
        if (rc != TSS2_RC_SUCCESS) {
            LOG(ERROR) << "nv_undefine: NV_UndefineSpace rc=0x" << std::hex << rc << " (final)";
            Esys_Free(pub); if (name) Esys_Free(name);
            Esys_TR_Close(esys, &nvHandle);
            Esys_Finalize(&esys);
            return false;
        }
    }

    // 5) Clean up and confirm itâ€™s gone
    Esys_Free(pub); if (name) Esys_Free(name);
    Esys_TR_Close(esys, &nvHandle);

    // Double-check: it should no longer be resolvable
    ESYS_TR check = ESYS_TR_NONE;
    rc = Esys_TR_FromTPMPublic(esys, nv_index, ESYS_TR_NONE, ESYS_TR_NONE, ESYS_TR_NONE, &check);
    Esys_Finalize(&esys);

    const bool gone = (rc != TSS2_RC_SUCCESS);
    if (!gone) {
        LOG(WARNING) << "nv_undefine: index still resolvable after undefine";
    }
    return gone;
}

          </code></pre>
        </div>
      </article>

      <article class="block">
        <div class="block-header">
          <div class="title" contenteditable="true">NULL</div>
          <div>
            <button>Copy</button>
            <button class="btn-green">Download</button>
          </div>
        </div>
        <div class="code-wrap">
          <pre><code contenteditable="true">
            <!-- Your CODE goes here -->

          </code></pre>
        </div>
      </article>
    </section>

    <footer>Built for quick sharing and personal snippets.</footer>
  </div>
</body>
</html>
