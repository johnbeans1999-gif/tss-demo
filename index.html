<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Titled Code Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22d3ee;
      --border: #1f2937;
      --btn: #0ea5e9;
      --btn-2: #14b8a6;
      --btn-3: #a78bfa;
      --radius: 12px;
    }

    html, body {
      height: 100%;
      background: radial-gradient(1200px 600px at 20% -10%, #1e293b 0%, #0b1020 40%, var(--bg) 100%);
      color: var(--text);
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    }

    .wrap {
      max-width: 1100px;
      margin: 40px auto 80px;
      padding: 0 16px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: 0.2px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      color: white;
      background: var(--btn);
      transition: transform .05s ease, filter .15s ease;
    }
    button:hover { filter: brightness(1.08); }
    button:active { transform: translateY(1px); }
    .btn-green { background: var(--btn-2); }
    .btn-purple { background: var(--btn-3); }

    /* 1 block per row */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .block {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 10px 24px rgba(0,0,0,.25);
      display: flex;
      flex-direction: column;
      min-height: 400px; /* bigger block height */
    }

    .block-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
    }

    .title {
      font-size: 15px;
      font-weight: 700;
      outline: none;
      border: none;
      background: transparent;
      color: var(--text);
      padding: 6px 8px;
      border-radius: 8px;
    }

    .code-wrap {
      position: relative;
      padding: 12px;
      flex: 1;
    }

    pre {
      margin: 0;
      overflow: auto;
      height: 100%;
      min-height: 350px; /* larger editable area */
      border-radius: 10px;
      border: 1px solid var(--border);
      background: radial-gradient(1200px 400px at 80% -80%, rgba(80,200,255,0.15), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      padding: 14px;
      font-size: 14px;
      line-height: 1.5;
      color: #e6edf3;
    }

    code[contenteditable="true"] {
      display: block;
      white-space: pre;
      caret-color: #fff;
      outline: none;
    }

    footer {
      text-align: center;
      margin-top: 26px;
      color: var(--muted);
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸŽ¯ TPM TSS Demo</h1>
      <div class="toolbar">
        <button class="btn-green">Add New Block</button>
        <button class="btn-purple">Download All</button>
      </div>
    </header>

    <section class="grid">
      <article class="block">
        <div class="block-header">
          <div class="title" contenteditable="true">C++ Snippet</div>
          <div>
            <button>Copy</button>
            <button class="btn-green">Download</button>
          </div>
        </div>
        <div class="code-wrap">
          <pre><code contenteditable="true">
<!-- Your CODE goes here -->
Indigo::Vector<Indigo::uint32_t> TPMManager_User::list_nv_indexes()
{
    Indigo::Vector<Indigo::uint32_t> out;

    // ESAPI init
    TSS2_ABI_VERSION abi = TSS2_ABI_VERSION_CURRENT;
    ESYS_CONTEXT* esys = nullptr;
    TSS2_RC rc = Esys_Initialize(&esys, p_tcti_context, &abi);
    if (rc != TSS2_RC_SUCCESS) {
        LOG(ERROR) << "list_nv_indexes: Esys_Initialize rc=0x" << std::hex << rc;
        return out;
    }

    TPMI_YES_NO more = TPM2_NO;
    TPMS_CAPABILITY_DATA* cap = nullptr;
    UINT32 selector = TPM2_HR_NV_INDEX;  // start of NV handle range (0x01000000)

    do {
        // Fetch up to N handles in the NV range
        rc = Esys_GetCapability(esys, ESYS_TR_NONE, ESYS_TR_NONE, ESYS_TR_NONE,
                                TPM2_CAP_HANDLES, selector, /*count*/64, &more, &cap);
        if (rc != TSS2_RC_SUCCESS || !cap) {
            LOG(ERROR) << "list_nv_indexes: GetCapability(handles-nv) rc=0x" << std::hex << rc;
            Esys_Finalize(&esys);
            return Indigo::Vector<Indigo::uint32_t>(); // empty on error
        }

        const TPML_HANDLE& hs = cap->data.handles;

        // Confirm each handle still exists by reading its public area
        for (UINT32 i = 0; i < hs.count; ++i) {
            ESYS_TR nvHandle = ESYS_TR_NONE;
            if (Esys_TR_FromTPMPublic(esys, hs.handle[i],
                                      ESYS_TR_NONE, ESYS_TR_NONE, ESYS_TR_NONE, &nvHandle)
                != TSS2_RC_SUCCESS) {
                continue; // skip if it disappeared between calls
            }

            TPM2B_NV_PUBLIC* pub = nullptr;
            TPM2B_NAME* name = nullptr;
            rc = Esys_NV_ReadPublic(esys, nvHandle,
                                    ESYS_TR_NONE, ESYS_TR_NONE, ESYS_TR_NONE,
                                    &pub, &name);
            if (rc == TSS2_RC_SUCCESS && pub) {
                out.push_back(static_cast<Indigo::uint32_t>(hs.handle[i]));
            }

            if (pub)  Esys_Free(pub);
            if (name) Esys_Free(name);
            Esys_TR_Close(esys, &nvHandle);
        }

        // Prepare next page (continue after the last handle we saw)
        if (hs.count > 0) {
            const UINT32 last = hs.handle[hs.count - 1];
            if (last == 0xFFFFFFFF) {
                more = TPM2_NO; // avoid wrap
            } else {
                selector = last + 1;
            }
        }

        Esys_Free(cap);
        cap = nullptr;
    } while (more == TPM2_YES);

    Esys_Finalize(&esys);
    return out;
}

          </code></pre>
        </div>
      </article>

      <article class="block">
        <div class="block-header">
          <div class="title" contenteditable="true">NULL</div>
          <div>
            <button>Copy</button>
            <button class="btn-green">Download</button>
          </div>
        </div>
        <div class="code-wrap">
          <pre><code contenteditable="true">
            <!-- Your CODE goes here -->

          </code></pre>
        </div>
      </article>
    </section>

    <footer>Built for quick sharing and personal snippets.</footer>
  </div>
</body>
</html>
